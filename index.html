<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff" id="theme-color-meta">
    <title>Generator Kod贸w v2.0</title>

    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-XXXXXXX');</script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        /* Zmienne CSS dla motyw贸w */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #1a1a1a;
            --container-bg: #ffffff;
            --primary-color: #005a9e;
            --primary-hover: #004a80;
            --accent-bg: #eef6fc;
            --border-color: #ccc;
            --focus-ring: #ffbf00;
            --error-color: #d93025;
            --barcode-bg: #ffffff;
            --input-bg: #ffffff;
        }

        /* Tryb ciemny */
        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --container-bg: #1e1e1e;
            --primary-color: #4da3ff;
            --primary-hover: #69b1ff;
            --accent-bg: #2d3748;
            --border-color: #444;
            --focus-ring: #ffbf00;
            --error-color: #ff6b6b;
            --barcode-bg: #ffffff;
            --input-bg: #2d2d2d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 1rem;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background-color: var(--container-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.3s;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        h1 {
            margin: 0;
            font-size: 1.4rem;
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            transition: all 0.2s;
        }
        
        .theme-toggle:hover {
            border-color: var(--primary-color);
        }

        fieldset {
            border: none;
            padding: 0;
            margin: 0 0 1.5rem 0;
        }

        legend {
            font-weight: 600;
            margin-bottom: 0.8rem;
            display: block;
            width: 100%;
            text-align: center;
            font-size: 1rem;
            opacity: 0.8;
        }

        /* Grid */
        #radio-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }

        .radio-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 12px 8px;
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            min-height: 50px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            font-weight: 500;
            height: 100%;
            box-sizing: border-box;
            color: var(--text-color);
        }

        .radio-option input[type="radio"]:checked + .radio-label {
            border-color: var(--primary-color);
            background-color: var(--accent-bg);
            color: var(--primary-color);
            font-weight: 700;
            box-shadow: 0 0 0 1px var(--primary-color) inset;
        }

        .radio-option input[type="radio"]:focus + .radio-label {
            outline: 3px solid var(--focus-ring);
        }

        .radio-option.full-width {
            grid-column: span 2;
        }

        /* Input Custom Container */
        #custom-input-container {
            display: none;
            margin-top: 15px;
            grid-column: span 2;
            background: var(--accent-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #custom-input-container.visible {
            display: block;
        }

        .custom-controls {
            display: flex;
            gap: 10px;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .input-wrapper label {
            font-size: 0.8rem;
            margin-bottom: 4px;
            font-weight: 600;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 1.1rem;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            text-align: center;
            text-transform: uppercase;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* Wyniki */
        #result-area {
            margin-top: auto;
            text-align: center;
        }

        #status-message {
            min-height: 20px;
            color: var(--error-color);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
            text-align: center;
        }

        #barcode-container {
            background: var(--barcode-bg);
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 110px;
            overflow: hidden; /* Na wypadek bardzo dugich kod贸w */
        }

        svg {
            max-width: 100%;
            height: auto;
        }

        #human-readable {
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 1.5rem;
            color: var(--text-color);
            word-break: break-all; /* amanie dugich kod贸w */
        }

        button.primary-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 16px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.1s, background-color 0.2s;
        }

        button.primary-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-XXXXXXX"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <main class="container">
        <header>
            <h1>Generator v2.0</h1>
            <button class="theme-toggle" id="themeBtn" aria-label="Przecz tryb ciemny"></button>
        </header>

        <fieldset>
            <legend>Wybierz seri biletu:</legend>
            <div id="radio-container">
                </div>
        </fieldset>

        <div id="result-area">
            <div id="status-message" aria-live="polite"></div>
            
            <div id="barcode-container" role="img" aria-label="Kod kreskowy">
                <svg id="barcode"></svg>
            </div>
            
            <div id="human-readable"></div>

            <button class="primary-btn" onclick="handleGenerate()">Generuj Kod</button>
        </div>
    </main>

    <script>
        // Version: 2.0
        
        // --- DANE ---
        const seriesData = {
            "descriptions": {
                "IA": "KA",
                "AS": "K Jednoraz.",
                "EE": "K Okres.",
                "JA": "KM Jednoraz.",
                "DZ": "SKM 3M",
                "CA": "KM",
                "ZZ": "IC Test"
            },
            "blocked": [
                "DB", "WB", "WE", "WH", "WK", "NE", "SE", "UB", "B", "VB",
                "WF", "WJ", "WL", "WM", "WN", "WP", "WQ", "WS", "WT", "WW", "eIC"
            ]
        };

        // --- ZARZDZANIE STANEM (LocalStorage) ---
        const STORAGE_KEY_THEME = 'barcode_app_theme';
        const STORAGE_KEY_SERIES = 'barcode_app_series';
        const STORAGE_KEY_CUSTOM = 'barcode_app_custom_val';
        const STORAGE_KEY_DIGITS = 'barcode_app_digits_val'; // Nowy klucz

        function loadPreferences() {
            // Motyw
            const savedTheme = localStorage.getItem(STORAGE_KEY_THEME);
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            }

            // Ostatnia seria
            const savedSeries = localStorage.getItem(STORAGE_KEY_SERIES);
            if (savedSeries) {
                const radio = document.querySelector(`input[name="seriesSelection"][value="${savedSeries}"]`);
                if (radio) {
                    radio.checked = true;
                    if (savedSeries === 'CUSTOM') {
                        document.getElementById('custom-input-container').classList.add('visible');
                    }
                }
            } else {
                document.getElementById('opt_RANDOM').checked = true;
            }

            // Ostatnia warto pola custom
            const savedCustom = localStorage.getItem(STORAGE_KEY_CUSTOM);
            if (savedCustom) {
                document.getElementById('customInput').value = savedCustom;
            }

            // Ostatnia ilo cyfr
            const savedDigits = localStorage.getItem(STORAGE_KEY_DIGITS);
            if (savedDigits) {
                document.getElementById('digitsInput').value = savedDigits;
            }
        }

        function savePreference(key, value) {
            localStorage.setItem(key, value);
        }

        // --- MOTYWY ---
        function applyTheme(theme) {
            const root = document.documentElement;
            const metaTheme = document.getElementById('theme-color-meta');
            
            if (theme === 'dark') {
                root.setAttribute('data-theme', 'dark');
                metaTheme.setAttribute('content', '#1e1e1e');
            } else {
                root.removeAttribute('data-theme');
                metaTheme.setAttribute('content', '#ffffff');
            }
        }

        function toggleTheme() {
            const root = document.documentElement;
            const current = root.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            savePreference(STORAGE_KEY_THEME, newTheme);
        }

        document.getElementById('themeBtn').addEventListener('click', toggleTheme);

        // --- UI INITIALIZATION ---
        const radioContainer = document.getElementById('radio-container');
        
        function initRadioButtons() {
            let html = '';
            
            // 1. Opcja Losowa
            html += createRadioHTML('RANDOM', ' Losowa (Automat)', false, true);

            // 2. Opcje z bazy - SORTOWANIE ALFABETYCZNE
            const sortedEntries = Object.entries(seriesData.descriptions).sort((a, b) => {
                return a[0].localeCompare(b[0]);
            });

            for (const [key, desc] of sortedEntries) {
                html += createRadioHTML(key, `<b>${key}</b><br><small>${desc}</small>`);
            }

            // 3. Opcja Wasna
            html += createRadioHTML('CUSTOM', '锔 Wasna seria', false, true);
            
            radioContainer.innerHTML = html;
            
            // 4. Kontener dla Wasnej Serii i Cyfr
            const inputContainer = document.createElement('div');
            inputContainer.id = 'custom-input-container';
            inputContainer.innerHTML = `
                <div class="custom-controls">
                    <div class="input-wrapper">
                        <label for="customInput">Seria (1-2 litery):</label>
                        <input type="text" id="customInput" maxlength="2" placeholder="np. A">
                    </div>
                    <div class="input-wrapper">
                        <label for="digitsInput">Ilo cyfr:</label>
                        <input type="number" id="digitsInput" value="8" min="4" max="20">
                    </div>
                </div>
            `;
            radioContainer.appendChild(inputContainer);

            // Listenery
            const radios = document.getElementsByName('seriesSelection');
            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    toggleCustomInput();
                    savePreference(STORAGE_KEY_SERIES, e.target.value);
                });
            });

            const customInput = document.getElementById('customInput');
            customInput.addEventListener('input', function(e) {
                 let val = e.target.value.toUpperCase().replace(/[^A-Z]/g, '');
                 e.target.value = val;
                 document.getElementById('status-message').innerText = "";
                 savePreference(STORAGE_KEY_CUSTOM, val);
            });

            // Listener dla iloci cyfr
            const digitsInput = document.getElementById('digitsInput');
            digitsInput.addEventListener('input', function(e) {
                 savePreference(STORAGE_KEY_DIGITS, e.target.value);
            });
        }

        function createRadioHTML(value, labelContent, checked = false, fullWidth = false) {
            const widthClass = fullWidth ? 'full-width' : '';
            return `
                <div class="radio-option ${widthClass}">
                    <input type="radio" name="seriesSelection" id="opt_${value}" value="${value}">
                    <label class="radio-label" for="opt_${value}">
                        ${labelContent}
                    </label>
                </div>
            `;
        }

        function toggleCustomInput() {
            const selected = document.querySelector('input[name="seriesSelection"]:checked').value;
            const customContainer = document.getElementById('custom-input-container');
            
            if (selected === 'CUSTOM') {
                customContainer.classList.add('visible');
                setTimeout(() => document.getElementById('customInput').focus(), 100);
            } else {
                customContainer.classList.remove('visible');
                document.getElementById('status-message').innerText = "";
            }
        }

        // --- LOGIC ---
        function isBlocked(series) {
            return seriesData.blocked.includes(series);
        }

        function getSafeRandomSeries() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let safeSeries = "";
            let attempts = 0;
            
            do {
                safeSeries = chars.charAt(Math.floor(Math.random() * chars.length)) + 
                             chars.charAt(Math.floor(Math.random() * chars.length));
                attempts++;
                if (attempts > 1000) return "XX"; 
            } while (isBlocked(safeSeries));

            return safeSeries;
        }

        function getRandomDigits(count) {
            let digits = "";
            for (let i = 0; i < count; i++) digits += Math.floor(Math.random() * 10);
            return digits;
        }

        function handleGenerate() {
            const selectedRadio = document.querySelector('input[name="seriesSelection"]:checked');
            const selectionType = selectedRadio ? selectedRadio.value : 'RANDOM';
            const statusMsg = document.getElementById('status-message');
            
            let finalSeries = "";
            let digitsCount = 8; // Domylnie 8 dla wszystkich poza Custom

            if (selectionType === 'RANDOM') {
                finalSeries = getSafeRandomSeries();
                statusMsg.innerText = "";
            } 
            else if (selectionType === 'CUSTOM') {
                const customVal = document.getElementById('customInput').value;
                // Pobieramy ilo cyfr, fallback do 8 jeli puste
                const customDigits = parseInt(document.getElementById('digitsInput').value) || 8;
                
                // Walidacja serii (1 lub 2 znaki)
                if (customVal.length < 1) {
                    statusMsg.innerText = "Wpisz co najmniej 1 liter.";
                    return;
                }
                if (isBlocked(customVal)) {
                    statusMsg.innerText = "Ta seria jest zablokowana.";
                    return;
                }
                
                finalSeries = customVal;
                digitsCount = customDigits;
                statusMsg.innerText = "";
            } 
            else {
                finalSeries = selectionType;
                statusMsg.innerText = "";
            }

            const fullCode = finalSeries + getRandomDigits(digitsCount);
            
            JsBarcode("#barcode", fullCode, {
                format: "CODE128",
                lineColor: "#000",
                width: 2, // Zmniejszyem nieco szeroko paska, 偶eby dugie kody weszy
                height: 80,
                displayValue: false,
                margin: 5
            });

            document.getElementById('human-readable').innerText = fullCode;
        }

        // Start
        initRadioButtons();
        loadPreferences();
        handleGenerate();

    </script>
</body>
</html>